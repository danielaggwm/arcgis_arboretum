name: Update Layers on Dashboard Change

# 1) Listen for manual runs, pushes to your local data folders,
#    AND dispatches from the Dashboard repo
on:
  workflow_dispatch:
  push:
    paths:
      - 'TMS_Data/**'
      - 'Dendrometer_Data/**'
  repository_dispatch:
    types: [dashboard-data-updated]

permissions:
  contents: write    # needed for checkout + push if you ever write back
  actions: read

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      # ─── Checkout ArcGIS repo ────────────────────────────────────────
      - name: Checkout ArcGIS repository
        uses: actions/checkout@v4

      # ─── Clone & copy dashboard data ─────────────────────────────────
      - name: Pull latest data from Dashboard repo
        env:
          DASHBOARD_PAT: ${{ secrets.DASHBOARD_PAT }}
        run: |
          # Clone your private dashboard repo into 'dashboard/'
          git clone https://x-access-token:${DASHBOARD_PAT}@github.com/danielaggwm/arboretum.git dashboard

          # Replace the local TMS_Data and Dendrometer_Data with the fresh ones:
          rm -rf TMS_Data Dendrometer_Data
          cp -r dashboard/D3_Dynamic_Plots/TMS_Data     TMS_Data
          cp -r dashboard/D3_Dynamic_Plots/Dendrometer_Data Dendrometer_Data

      # ─── Set up Python & deps ────────────────────────────────────────
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      # ─── Run your update script ──────────────────────────────────────
      - name: Run update_layers.py
        env:
          AGO_ORG_URL:       ${{ secrets.AGO_ORG_URL }}
          AGO_USERNAME:      ${{ secrets.AGO_USERNAME }}
          AGO_PASSWORD:      ${{ secrets.AGO_PASSWORD }}
          DENDRO_AVG_ITEMID: ${{ secrets.DENDRO_AVG_ITEMID }}
          DENDRO_DAILY_ITEMID: ${{ secrets.DENDRO_DAILY_ITEMID }}
          TMS_AVG_ITEMID:    ${{ secrets.TMS_AVG_ITEMID }}
          DBH_ITEMID:        ${{ secrets.DBH_ITEMID }}
        run: |
          python Scripts/update_layers.py
